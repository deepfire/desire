<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
lang="en" xml:lang="en">
<head>
<title>Overview of desire, a software knowledge and distribution system</title>
<meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2011-01-27 15:07:31 MSK"/>
<meta name="author" content="Samium Gromoff"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>
<div id="content">

<h1 class="title">Overview of desire, a software knowledge and distribution system</h1>


<div style="text-align: center">
<p>January 16, 2010, 19:37
</p>
</div>


<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1 About this document </a></li>
<li><a href="#sec-2">2 What is desire (supposed to be)? </a></li>
<li><a href="#sec-3">3 What can desire do for you <i>now</i>? </a>
<ul>
<li><a href="#sec-3_1">3.1 End user </a></li>
<li><a href="#sec-3_2">3.2 Upstreams </a>
<ul>
<li><a href="#sec-3_2_1">3.2.1 Non-participating upstreams </a></li>
<li><a href="#sec-3_2_2">3.2.2 Participating upstreams a.k.a. wishmasters </a></li>
</ul>
</li>
<li><a href="#sec-3_3">3.3 Tinkerer </a></li>
</ul>
</li>
<li><a href="#sec-4">4 Installation </a>
<ul>
<li><a href="#sec-4_1">4.1 Requirements </a></li>
<li><a href="#sec-4_2">4.2 Bootstrap and initialisation </a>
<ul>
<li><a href="#sec-4_2_1">4.2.1 Manual installation </a></li>
<li><a href="#sec-4_2_2">4.2.2 Semi-automated installation </a></li>
<li><a href="#sec-4_2_3">4.2.3 Fully automated bootstrap </a></li>
<li><a href="#sec-4_2_4">4.2.4 Bootstrap script reference </a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-5">5 Workflows </a>
<ul>
<li><a href="#sec-5_1">5.1 Re-initialisation </a></li>
<li><a href="#sec-5_2">5.2 User aspect </a></li>
<li><a href="#sec-5_3">5.3 Wishmaster aspect </a>
<ul>
<li>
<ul>
<li><a href="#sec-5_3_1">5.3.1 External executables required for module conversion </a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-5_4">5.4 Extending definitions </a></li>
</ul>
</li>
<li><a href="#sec-6">6 Overview of terms </a>
<ul>
<li><a href="#sec-6_1">6.1 DEFINITIONS </a></li>
<li><a href="#sec-6_2">6.2 Distributors </a>
<ul>
<li><a href="#sec-6_2_1">6.2.1 Wishmasters </a></li>
</ul>
</li>
<li><a href="#sec-6_3">6.3 Locations </a>
<ul>
<li><a href="#sec-6_3_1">6.3.1 Remotes </a>
<ul>
<li><a href="#sec-6_3_1_1">6.3.1.1 Non-gate remotes </a></li>
<li><a href="#sec-6_3_1_2">6.3.1.2 Gate remotes, or gates </a></li>
</ul>
</li>
<li><a href="#sec-6_3_2">6.3.2 Localities </a></li>
<li><a href="#sec-6_3_3">6.3.3 Local gate, or gate locality </a></li>
</ul>
</li>
<li><a href="#sec-6_4">6.4 Modules </a>
<ul>
<li><a href="#sec-6_4_1">6.4.1 Pseudo-modules </a></li>
</ul>
</li>
<li><a href="#sec-6_5">6.5 Systems </a></li>
<li><a href="#sec-6_6">6.6 Applications </a></li>
</ul>
</li>
<li><a href="#sec-7">7 API (aka end-user interface) </a>
<ul>
<li><a href="#sec-7_1">7.1 Initial chores &amp; storage location choice </a></li>
<li><a href="#sec-7_2">7.2 Performing knowledge base queries </a></li>
<li><a href="#sec-7_3">7.3 Making wishes </a>
<ul>
<li><a href="#sec-7_3_1">7.3.1 Reader macros for add-module </a></li>
</ul>
</li>
<li><a href="#sec-7_4">7.4 Less frequently used functions </a></li>
</ul>
</li>
<li><a href="#sec-8">8 Shortcomings </a></li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> About this document </h2>
<div class="outline-text-2" id="text-1">


<p>
This document has a canonical location:
</p>
<p>
<a href="http://www.feelingofgreen.ru/shared/src/desire/doc/overview.html">http://www.feelingofgreen.ru/shared/src/desire/doc/overview.html</a>
</p>
<p>
or, for the Org-mode source:
</p>
<p>
<a href="http://www.feelingofgreen.ru/shared/src/desire/doc/overview.org">http://www.feelingofgreen.ru/shared/src/desire/doc/overview.org</a>
</p>
<p>
In case you are looking for a short, take-no-prisoners introduction, you may
consider the crash tutorial:
</p>
<p>
<a href="http://www.feelingofgreen.ru/shared/src/desire/doc/tutorial.html">http://www.feelingofgreen.ru/shared/src/desire/doc/tutorial.html</a>
</p>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> What is desire (supposed to be)? </h2>
<div class="outline-text-2" id="text-2">


<p>
Desire is a source code management substrate.  It once was called a
"package management substrate", but no longer, because, while it
does some things a package manager like APT or YUM would do, the actual
packaging part is not represented.
</p>
<p>
Desire probably is best described as a sum of its current components:
</p><ul>
<li>
a DSL enumerating software module upstreams and facilitating a global
namespace for described objects, augmented with rich supporting facilities;
</li>
<li>
a nascent VCS management layer<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>;
</li>
<li>
a repository format unifier based on the above, facilitating
redistribution of upstream source code in a common DVCS format;
</li>
<li>
a set of inter-module dependency deducers<sup><a class="footref" name="fnr.2" href="#fn.2">2</a></sup> for various
situations, but most importantly allowing for automated
end-user-oriented module retrieval and installation;
</li>
<li>
a number of auxiliary tools based on that substrate:
<ul>
<li>
a semi-automated clbuild project definition importer;
</li>
<li>
a fairly automated packager for ASDF-INSTALL;
</li>
<li>
an automated patch applicator providing a set of XCVBified projects;
</li>
<li>
a buildbot with a master/slave architecture and a web interface
supporting both static and dynamic page generation.
</li>
</ul>
</li>
</ul>


<p>
If this sounds like running in all directions, it probably is, as the goal
of desire is to become a substrate supporting all source-code-related
activities &ndash; module enumeration, (re-)distribution, upstream tracking,
release management, packaging, testing etc.
</p>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> What can desire do for you <i>now</i>? </h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3_1" class="outline-3">
<h3 id="sec-3_1"><span class="section-number-3">3.1</span> End user </h3>
<div class="outline-text-3" id="text-3_1">


<p>
You can use desire in the same manner as ASDF-INSTALL, but in a somewhat more friendly
manner:
</p><ul>
<li>
no non-essential packages need to be installed, because desire has a concept of
central system of a module<sup><a class="footref" name="fnr.3" href="#fn.3">3</a></sup>;
</li>
<li>
you can ask it about available modules in an apropos-like fashion, because of
the availability of an explicitly declared nomenclature;
</li>
</ul>


<p>
Additionally, you can use it to track non-lisp upstreams &ndash; without dependency handling,
for obvious reasons.
</p>
</div>

</div>

<div id="outline-container-3_2" class="outline-3">
<h3 id="sec-3_2"><span class="section-number-3">3.2</span> Upstreams </h3>
<div class="outline-text-3" id="text-3_2">


<p>
There are two modes of operation, a participating one and a non-participating one.
</p>
<p>
The latter requires almost no involvement on upstream's part &ndash; not even use of desire,
whereas the former assumes control over the definition of the corresponding part of the
global upstream namespace.
</p>
<p>
In either case you get:
</p><ul>
<li>
your modules and their dependencies are globally declared and easily available
to end-users;
</li>
<li>
buildbot-style testing on <a href="http://feelingofgreen.ru/desire-waterfall">http://feelingofgreen.ru/desire-waterfall</a> <sup><a class="footref" name="fnr.4" href="#fn.4">4</a></sup>.
</li>
</ul>



</div>

<div id="outline-container-3_2_1" class="outline-4">
<h4 id="sec-3_2_1"><span class="section-number-4">3.2.1</span> Non-participating upstreams </h4>
<div class="outline-text-4" id="text-3_2_1">


<p>
You don't have to do anything, but perhaps ask the desire maintainers to record definitions
of modules released by you and of their dependencies, that is, if they are not recorded already.
</p>
</div>

</div>

<div id="outline-container-3_2_2" class="outline-4">
<h4 id="sec-3_2_2"><span class="section-number-4">3.2.2</span> Participating upstreams a.k.a. wishmasters </h4>
<div class="outline-text-4" id="text-3_2_2">


<p>
You get to maintain your portion of global definitions and a set of publicly accessible
git repositories.
</p>
<p>
In return, you get following things:
</p><ul>
<li>
easy upstream dependency tracking (really, an end-user mode feature);
</li>
<li>
programmatic API for certain aspects of git repository operation;
</li>
<li>
semi-automatic ASDF-INSTALL exporter;
</li>
<li>
possibility to run a local instance of the buildbot.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-3_3" class="outline-3">
<h3 id="sec-3_3"><span class="section-number-3">3.3</span> Tinkerer </h3>
<div class="outline-text-3" id="text-3_3">


<p>
You know you're in this category when you want to do things like:
</p><ul>
<li>
programmatically generate/maintain/test changes/branches across a set of modules,
like the automated XCVBifier does, perhaps for facilitating coordinated
release making;
</li>
<li>
programmatically populate the definition namespace (perhaps for a
web-sphere where people could register and manipulate their projects);
</li>
<li>
extend the buildbot infrastructure, perhaps adding things like automated
package generation phase;
</li>
</ul>


<p>
I won't go into details at this point, but I believe that desire provides enough
foothold to make all that feasible, if not easy-ish.
</p>
<p>
Like with any underspecified area, desire employs a degree of heuristics here and there --
and that's where we need specifications to make things predictable and reliable.
</p>
</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Installation </h2>
<div class="outline-text-2" id="text-4">


<p>
The ultimate goal of actions described in this section is to provide the user
with a REPL fully prepared for input of desire commands.
</p>

</div>

<div id="outline-container-4_1" class="outline-3">
<h3 id="sec-4_1"><span class="section-number-3">4.1</span> Requirements </h3>
<div class="outline-text-3" id="text-4_1">


<p>
Absolute requirements at this point are a POSIX shell, git and SBCL.
</p>
</div>

</div>

<div id="outline-container-4_2" class="outline-3">
<h3 id="sec-4_2"><span class="section-number-3">4.2</span> Bootstrap and initialisation </h3>
<div class="outline-text-3" id="text-4_2">


<p>
Besides the obvious download and compilation/load steps, desire requires
an initialisation procedure parametrised with a source code storage area,
in order to become operational.
</p>
<p>
All these steps can be carried out:
</p><ul>
<li>
manually;
</li>
<li>
in a semi-automated manner, with assist of ASDF-INSTALL;
</li>
<li>
in a completely automated manner, using the bootstrap script.
</li>
</ul>


<p>
Before we proceed, a crucial concept of the storage area must be discussed.
</p>
<p>
The storage area is a writable directory whose writable subdirectories
fall into one of the three categories:
</p><ul>
<li>
module repositories maintained by desire through git;
</li>
<li>
<i>foreign</i> VCS subroots containing transitory repositories in
foreign formats;
</li>
<li>
metadata repositories used for desire's internode communication
and information tracking.
</li>
</ul>


<p>
For the time being, the system-wide policy for maintenance of these
storage roots is not devised yet, so they are effectively per-user.
</p>
<p>
Unless you go the fully-automated bootstrap way, the first time you run
desire you will need to prepare an empty writeable directory.
</p>

</div>

<div id="outline-container-4_2_1" class="outline-4">
<h4 id="sec-4_2_1"><span class="section-number-4">4.2.1</span> Manual installation </h4>
<div class="outline-text-4" id="text-4_2_1">


<pre class="example">
root="/absolute/path/to/storage-area/"
</pre>


<p>
The remaining of the shell snippet is designed to be pastable into a shell:
</p>



<pre class="example">mkdir ${root}
cd ${root}
dependencies="alexandria asdf cl-fad desire executor pergamum iterate"
for dep in ${dependencies}
do
        git clone -o git.feelingofgreen.ru git://git.feelingofgreen.ru/$dep
        # alternative for behind-HTTP-proxy world:
        # git clone -o git.feelingofgreen.ru http://git.feelingofgreen.ru/shared/src/$dep/.git/
        ln -s ${root}/$dep/$dep.asd
done
sbcl --no-userinit --no-sysinit --eval '(load (compile-file "asdf/asdf.lisp"))' \
     --eval "(require :desire)" \
     --eval "(desire:init \"${root}\")" \
     --eval "(in-package :desire)"
</pre>



</div>

</div>

<div id="outline-container-4_2_2" class="outline-4">
<h4 id="sec-4_2_2"><span class="section-number-4">4.2.2</span> Semi-automated installation </h4>
<div class="outline-text-4" id="text-4_2_2">


<p>
This mode is intended to use ASDF-INSTALL, but alas it doesn't work,
as you need to be in SBCL without ASDF loaded, because desire depends on a
development version of ASDF which is not yet integrated into SBCL.
</p>
</div>

</div>

<div id="outline-container-4_2_3" class="outline-4">
<h4 id="sec-4_2_3"><span class="section-number-4">4.2.3</span> Fully automated bootstrap </h4>
<div class="outline-text-4" id="text-4_2_3">


<p>
Desire includes a booststrap script which is located at:
</p>
<p>
<a href="http://www.feelingofgreen.ru/shared/src/desire/climb.sh">http://www.feelingofgreen.ru/shared/src/desire/climb.sh</a>
</p>
<p>
Download that script and run it like that (the trailing slash is important):
</p>
<pre class="example">
sh climb.sh /absolute/path/to/storage-root/
</pre>


<p>
The reference for various controls follows.
</p>
</div>

</div>

<div id="outline-container-4_2_4" class="outline-4">
<h4 id="sec-4_2_4"><span class="section-number-4">4.2.4</span> Bootstrap script reference </h4>
<div class="outline-text-4" id="text-4_2_4">


<p>
This script performs following operations:
</p>
<ul>
<li>
 use git to download modules desire depends on, placing them
in the provided storage location;
</li>
<li>
 load and perform an initial setup of desire;
</li>
<li>
 optionally install a desired module and its dependencies;
</li>
<li>
 optionally evaluate an expression in the resulting environment.
</li>
</ul>


<p>
Invoke it like this:
</p>



<pre class="example">  climb.sh [OPTION]... [STORAGE-ROOT]
Bootstrap, update or perform other actions on a desire installation
in either STORAGE-ROOT, or a location specified in ~/.climb-root

  -u          Self-update and continue processing other options, using
                the updated version.
  -n HOSTNAME Use HOSTNAME as a bootstrap node.
                HOSTNAME must refer to a node participating in desire protocol.
  -b BRANCH   Check out BRANCH of desire other than 'master'.
  -t BRANCH   Check out BRANCH of metastore on the bootstrap node other than
                the default.  The default is the same as the used branch
                of desire.
  -m MODULE   Retrieve MODULE, once ready.
  -s SYSTEM   Install or update the module relevant to SYSTEM, then load it.
  -a APP      Load system containing APP, as per -s, then launch it.
  -x EXPR     Evaluate an expression, in the end of it all.
  -d          Enable debug optimisation of Lisp code.
  -n          Disable debugger, causing desire dump stack and abort on errors,
                instead of entering the debugger.
  -e          Enable explanations about external program invocations.
  -v          Crank up verbosity.
  -V          Print version.
  -h          Display a help message.
</pre>



<p>
As step zero, when the -u switch is provided, climb.sh is updated using wget
from the canonical location at <a href="http://www.feelingofgreen.ru/shared/src/desire/climb.sh">http://www.feelingofgreen.ru/shared/src/desire/climb.sh</a>,
and then normal processing is continued, using the updated version.
</p>
<p>
During the first step, a storage root location is either created or validated.
The pre-existing storage root must be a writable directory containing a
writable 'git' subdirectory.
</p>
<p>
When STORAGE-ROOT is not specified, ~/.climb-root is looked up for an
absolute pathname referring to a valid storage location.  If this condition
is met, that directory is accepted as STORAGE-ROOT, otherwise an error
is signalled.
</p>
<p>
When STORAGE-ROOT is specified, it must be either an absolute pathname
referring to a valid storage location, or it must denote a non-occupied
filesystem location, with a writable parent directory.
</p>
<p>
During the second step, desire and its dependencies are either retrieved,
or updated, in the case when they are already present in STORAGE-ROOT.
</p>
<p>
Next, a specific branch of desire is checked out, configurable with the
-d option and defaulting to "master".
</p>
<p>
Further, the -n and -t options alter, correspondingly, the hostname
of the desire node used for bootstrap, and a branch of that node's metastore
to use.  These options default to git.feelingofgreen.ru and
the name of the branch of desire, accordingly.
</p>
<p>
During the next step a lisp is started and desire initialisation is attempted,
with the above determined values of hostname and metastore branch.
</p>
<p>
Once the initialisation is complete, MODULE, SYSTEM and APP provide
optional convenience shortcuts for module installation, system loading
and application launching.  Any of these can be omitted, as the required
information is easily deduced.  Note that the more granular objects
determine the objects of lower granularity.
</p>
<p>
After all these steps, EXPR is executed, if it was provided.
</p>
</div>
</div>
</div>

</div>

<div id="outline-container-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Workflows </h2>
<div class="outline-text-2" id="text-5">


<p>
This section assumes that desire was already made operational by either
means described in the previous chapter.
</p>

</div>

<div id="outline-container-5_1" class="outline-3">
<h3 id="sec-5_1"><span class="section-number-3">5.1</span> Re-initialisation </h3>
<div class="outline-text-3" id="text-5_1">


<p>
The INIT procedure ensures that repositories constituting your desire node
are in working order.
</p>
<p>
Depending on whether you run a well-known desire node (that is, a wishmaster)
you need to provide the :AS keyword to INIT:
</p>
<pre class="example">
(init "/path/to/root/")                            ; for non-well-known mode
</pre>

<p>or:
</p><pre class="example">
(init "/path/to/root/" :as 'your-node-domain-name) ; for wishmaster mode
</pre>


<p>
The specified root directory will contain all VCS-specific master localities,
as well as anything module's post-install scripts choose to deliver.
This pathname is available in <code>*SELF*</code>, using the ROOT reader.
</p>
<p>
Unless you already have a '.meta' module, an initial seed version will be
downloaded for you.  Currently the wishmaster chosen for this is
git.feelingofgreen.ru.
</p>
<p>
This procedure also determines the available VCS tools, as well as conversion
tools, and determines the set of accessible remotes.
</p>
<p>
Further, it scans the git locality for known modules, and makes their systems
registered in the ASDF registry.
</p>
</div>

</div>

<div id="outline-container-5_2" class="outline-3">
<h3 id="sec-5_2"><span class="section-number-3">5.2</span> User aspect </h3>
<div class="outline-text-3" id="text-5_2">


<p>
Unless you happen to have some conversion tools, the set of modules available
to your node is restricted to those available via git remotes.
</p>
<p>
The DESIRE function serves to either initially download or update a set of defined
modules.
</p>
<p>
APROPOS-DESR and LIST-MODULES provide convenient knowledge base query
facilities. For a wider set of functions, please see section 3.
</p>
</div>

</div>

<div id="outline-container-5_3" class="outline-3">
<h3 id="sec-5_3"><span class="section-number-3">5.3</span> Wishmaster aspect </h3>
<div class="outline-text-3" id="text-5_3">


<p>
From the wishmaster point of view the INIT function also does:
</p>
<ul>
<li>
 checks that the locally available set of modules covers every module
that is claimed to be "well known" to be published by our
distributor<sup><a class="footref" name="fnr.5" href="#fn.5">5</a></sup>, otherwise signalling an error
</li>
<li>
 publishes the informations about non-released, converted modules
in the gate remote's DEFINITIONS file
</li>
</ul>



</div>

<div id="outline-container-5_3_1" class="outline-5">
<h5 id="sec-5_3_1"><span class="section-number-5">5.3.1</span> External executables required for module conversion </h5>
<div class="outline-text-5" id="text-5_3_1">


<p>
The conversion is performed by external programs:
</p>
<ul>
<li>
 darcs-to-git<sup><a class="footref" name="fnr.6" href="#fn.6">6</a></sup>
</li>
<li>
 git cvs, debian package git-cvs
</li>
<li>
 git svn, debian package git-svn
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-5_4" class="outline-3">
<h3 id="sec-5_4"><span class="section-number-3">5.4</span> Extending definitions </h3>
<div class="outline-text-3" id="text-5_4">


<p>
ADD-MODULE and the accompanying reader macro #@"u://r.l/" is a one-stop
point useful for manual extension of the set of known entities.  The URI
type of the URL must name to the VCS used at the given distribution point,
that is one of 'git', 'http' (which actually means git+http), 'darcs',
'cvs' or 'svn'.
</p>
<p>
The required super-entities are either found among current definitions,
or created on the spot.
</p>
<p>
SAVE-DEFINITIONS writes out changes into
&lt;value-of-(ROOT <code>*SELF*</code>)&gt;/git/.meta/DEFINITIONS
</p>
</div>
</div>

</div>

<div id="outline-container-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Overview of terms </h2>
<div class="outline-text-2" id="text-6">


</div>

<div id="outline-container-6_1" class="outline-3">
<h3 id="sec-6_1"><span class="section-number-3">6.1</span> DEFINITIONS </h3>
<div class="outline-text-3" id="text-6_1">


<p>
This is the term you will often see mentioned, as it is central to
the process of distribution of information about the domain.
</p>
<p>
For the moment it would suffice to say that this is a text file
containing forms (which are READable using desire-provided readers) which
carry information about terms covered in this section.
</p>
</div>

</div>

<div id="outline-container-6_2" class="outline-3">
<h3 id="sec-6_2"><span class="section-number-3">6.2</span> Distributors </h3>
<div class="outline-text-3" id="text-6_2">


<p>
The largest unit of software granularity is a <i>distributor</i>, which
corresponds to an internet domain name<sup><a class="footref" name="fnr.7" href="#fn.7">7</a></sup>.  Currently, they don't carry
much information beyond just that.
</p>
<p>
Distributors contain one or more <i>remotes</i>, which correspond to points
of distribution of sets of similarly-accessible modules.
</p>

</div>

<div id="outline-container-6_2_1" class="outline-4">
<h4 id="sec-6_2_1"><span class="section-number-4">6.2.1</span> Wishmasters </h4>
<div class="outline-text-4" id="text-6_2_1">


<p>
<i>Wishmaster</i> is a subtype of distributor which participates in the
desire network, in the form of being recorded in <i>DEFINITIONS</i>, as well as
by maintaining a <i>gate</i> (a subtype of remotes upon which we will elaborate
further below).  When applied to <i>wishmasters</i>, the virtue of being
registered in <i>some</i> DEFINITIONS is otherwise referred to as property
of being <i>well-known</i>.
</p>
<p>
Two important processes naturally growing out of this are:
</p><ul>
<li>
exchange of DEFINITIONS, be it among well-known wishmasters, or
as a process of informing a client node, and
</li>
<li>
upstream module conversion, which ends up populating the <i>gate</i>;
</li>
</ul>


<p>
The upstream module conversion process serves to simplify life of average
desire users by repackaging modules available through a variety
of distribution means<sup><a class="footref" name="fnr.8" href="#fn.8">8</a></sup> into a common DVCS format.
</p>
<p>
The wishmaster corresponding to the local desire instance is available
through the variable called <code>*SELF*</code>.
</p>
</div>
</div>

</div>

<div id="outline-container-6_3" class="outline-3">
<h3 id="sec-6_3"><span class="section-number-3">6.3</span> Locations </h3>
<div class="outline-text-3" id="text-6_3">


<p>
<i>Location</i> is a general term for objects storing <i>module</i> repositories,
and are either local, in which case they are <i>localities</i>, or non-local,
in which case they are, unsurprisingly, /remotes/<sup><a class="footref" name="fnr.9" href="#fn.9">9</a></sup>.
</p>

</div>

<div id="outline-container-6_3_1" class="outline-4">
<h4 id="sec-6_3_1"><span class="section-number-4">6.3.1</span> Remotes </h4>
<div class="outline-text-4" id="text-6_3_1">


<p>
The concept of <i>remote</i> serves as a point of distribution for a group of <i>modules</i>.
</p>
<p>
In general, all remotes carry the following information:
</p><ul>
<li>
version control system type (git, darcs, cvs or svn),
</li>
<li>
transport type (native, http or rsync),
</li>
<li>
simple pattern for matching module paths on the distributor,
</li>
<li>
an internet port number, and
</li>
<li>
some additional quirks necessary to access the remote repository;
</li>
</ul>



</div>

<div id="outline-container-6_3_1_1" class="outline-5">
<h5 id="sec-6_3_1_1"><span class="section-number-5">6.3.1.1</span> Non-gate remotes </h5>
<div class="outline-text-5" id="text-6_3_1_1">


<p>
<i>Non-gate remotes</i> represent distribution points of non-wishmasters, that is,
nodes not participating in the desire protocol.
</p>
</div>

</div>

<div id="outline-container-6_3_1_2" class="outline-5">
<h5 id="sec-6_3_1_2"><span class="section-number-5">6.3.1.2</span> Gate remotes, or gates </h5>
<div class="outline-text-5" id="text-6_3_1_2">


<p>
<i>Gate remotes</i>, or <i>gates</i> are special remotes which are instrumental
to participation in the desire protocol.  They carry a special module called
<b>.meta</b>, which records the containing distributor's idea about the domain
in aforementioned DEFINITIONS.
</p>
<p>
The information in this file is subject to propagation in the network
of hosts participating in the desire protocol.
</p>
<p>
Gate remotes have a second purpose: as parts of well-known wishmasters
they serve for redistribution of modules converted by those wishmasters
into a single repository format, currently <i>git</i>.  The modules converted
in such a way are advertised differently from those which are considered
'released' by the containing distributor.
</p>
</div>
</div>

</div>

<div id="outline-container-6_3_2" class="outline-4">
<h4 id="sec-6_3_2"><span class="section-number-4">6.3.2</span> Localities </h4>
<div class="outline-text-4" id="text-6_3_2">


<p>
<i>Localities</i> serve to express module storage on the local machine.
<i>Master localities</i> (except the <i>local gate</i>, about which see below)
are canonical transitory locations used for conversion of modules
retrieved from remotes of specific VCS types.
</p>
<p>
<i>The master git locality</i>, also the <i>local gate</i> or a <i>gate locality</i>, is
described in the next section, and is supposed to be a canonical storage
location for all modules used on the desire node.
</p>
<p>
A scrupulous reader might note that the above description leaves open
a possibility of existence for <i>non-master localities</i>.  While it is true,
and purposefully so, this concept is not currently employed.
</p>
</div>

</div>

<div id="outline-container-6_3_3" class="outline-4">
<h4 id="sec-6_3_3"><span class="section-number-4">6.3.3</span> Local gate, or gate locality </h4>
<div class="outline-text-4" id="text-6_3_3">


<p>
<code>*SELF*</code> always contains a special location, a <i>local gate</i> or a <i>gate locality</i>,
which is both a remote and a locality and serves a threefold purpose:
</p>
<ul>
<li>
storage of incoming modules for local consumption,
</li>
<li>
export of the aforementioned converted modules, and
</li>
<li>
distribution point for modules released by the local distributor.
</li>
</ul>


<p>
Naturally, the last two points only apply to well-known wishmasters.
</p>
</div>
</div>

</div>

<div id="outline-container-6_4" class="outline-3">
<h3 id="sec-6_4"><span class="section-number-3">6.4</span> Modules </h3>
<div class="outline-text-3" id="text-6_4">


<p>
<i>Modules</i> represent versioned, atomic units of software, as released
by the distributor, and, from the point of desire, carry the additional
information necessary to complete the information provided by
the less granular concepts to obtain the module from its containing remote.
</p>
<p>
Modules can be provided by several different remotes of different
distributors.  When the end-user requests retrieval of a module, gate remotes
are preferred above others.
</p>
<p>
Locally, all incoming modules end up in the local gate, which
always exists, nevermind the dominant operation mode of the desire node.
Once in the local gate, the module becomes /locally available/<sup><a class="footref" name="fnr.10" href="#fn.10">10</a></sup>, and is
made loadable through the preferred local system definition facility.
</p>
<p>
Locally available modules can be classified into one of the four
categories, the first two of which are only applicable to well-known
wishmasters:
</p>
<ul>
<li>
released, for modules advertised through DEFINITIONS to be released
through the distributor corresponding to <code>*SELF*</code>;
</li>
<li>
converted, for module originating elsewhere, but advertised in
DEFINITIONS as being converted in the gate of <code>*SELF*</code>;
</li>
<li>
unpublished, modules accessible through the gate, yet unadvertised
in DEFINITIONS;
</li>
<li>
hidden, modules physically present in the local gate, but made
unavailable to anonymous remote clients<sup><a class="footref" name="fnr.11" href="#fn.11">11</a></sup>.
</li>
</ul>



</div>

<div id="outline-container-6_4_1" class="outline-4">
<h4 id="sec-6_4_1"><span class="section-number-4">6.4.1</span> Pseudo-modules </h4>
<div class="outline-text-4" id="text-6_4_1">


<p>
<i>Pseudo-modules</i> refer to repositories stored in gates used for desire-specific
information storage and exchange.  Currently there are two common pseudo-modules:
</p>
<ul>
<li>
<b>.meta</b>, the aforementioned domain-specific information junction point, and
</li>
<li>
<b>.local-meta</b>, a hidden repository used to store local information, which
currently amounts to tracking unpublished and hidden modules.
</li>
</ul>


</div>
</div>

</div>

<div id="outline-container-6_5" class="outline-3">
<h3 id="sec-6_5"><span class="section-number-3">6.5</span> Systems </h3>
<div class="outline-text-3" id="text-6_5">


<p>
Descending further down we meet <i>systems</i>.
Systems are objects only meant to be relevant in the domain of Common Lisp
software, and more precisely &ndash; to backend system definition facilities,
such as ASDF, XCVB, Mudballs or others<sup><a class="footref" name="fnr.12" href="#fn.12">12</a></sup>.
</p>
<p>
The concept of system introduces inter-system dependencies, which cross
module boundaries, producing inter-module dependencies.
</p>
<p>
Evidently, there can be several systems per module, and also those can be
obscured from the end-user, either intentionally or by unfortunate
accident<sup><a class="footref" name="fnr.13" href="#fn.13">13</a></sup>.
</p>
<p>
Desire handles all these complications and operates on the full
inter-module dependency graph.  It also doesn't store that graph anywhere,
recomputing it, instead, every time a request for a module is performed.
</p>
<p>
It should be noted, that there is no requirement for modules to have systems,
which enables end-users to manage (and provide) gittified non-Lisp software
for local (and not-so-local) needs.
</p>
</div>

</div>

<div id="outline-container-6_6" class="outline-3">
<h3 id="sec-6_6"><span class="section-number-3">6.6</span> Applications </h3>
<div class="outline-text-3" id="text-6_6">


<p>
Applications are simple extensions of systems, providing some very
preliminary support for launching programs.  They are intended to simplify
end-user experience by making requests such as "run climacs" expressible
and actionable.
</p>
</div>
</div>

</div>

<div id="outline-container-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> API (aka end-user interface) </h2>
<div class="outline-text-2" id="text-7">


</div>

<div id="outline-container-7_1" class="outline-3">
<h3 id="sec-7_1"><span class="section-number-3">7.1</span> Initial chores &amp; storage location choice </h3>
<div class="outline-text-3" id="text-7_1">


<dl>
<dt>init path &amp;key as (default-wishmasters (list desr:*default-wishmaster*)) =&gt; &lt;no values&gt;</dt><dd>

<p>
Initialise desire with PATH chosen as directory for storage of all VCS-specific locations.
</p>
<p>
When AS is non-NIL an attempt is made to establish an identity to a defined distributor
named by the AS keyword.
</p>
<p>
This is performed by checking that the locally available set of modules covers every module
that is claimed to be to be published by our distributor<sup><a class="footref" name="fnr.5.2" href="#fn.5">5</a></sup>, according to the local
DEFINITIONS.  When this check fails an error is signalled.
</p>
</dd>
<dt><code>*self*</code> =&gt; distributor</dt><dd>

<p>
The local distributor set up during INIT, be it well-known or not.
</p>
</dd>
<dt>root local-distributor =&gt; pathname</dt><dd>

<p>
The root directory containing all VCS-specific locations of LOCAL-DISTRIBUTOR, chosen during INIT-time.
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-7_2" class="outline-3">
<h3 id="sec-7_2"><span class="section-number-3">7.2</span> Performing knowledge base queries </h3>
<div class="outline-text-3" id="text-7_2">

<dl>
<dt>distributor name &amp;key (if-does-not-exist :error) =&gt; distributor</dt><dd>

</dd>
<dt>remote name &amp;key (if-does-not-exist :error) =&gt; remote</dt><dd>

</dd>
<dt>module name &amp;key (if-does-not-exist :error) =&gt; module</dt><dd>

</dd>
<dt>system name &amp;key (if-does-not-exist :error) =&gt; system</dt><dd>

</dd>
<dt>app name &amp;key (if-does-not-exist :error) =&gt; app</dt><dd>

</dd>
<dt>locality name &amp;key (if-does-not-exist :error) =&gt; locality</dt><dd>

<p>
Find objects by name.
</p>
</dd>
<dt>name object =&gt; symbol</dt><dd>

<p>
Yield object's name.
</p>
</dd>
<dt>url remote-designator &amp;optional module-specifier =&gt; string</dt><dd>

<p>
Compute the URL of a module designated by MODULE-SPECIFIER contained a remote designated by
REMOTE-DESIGNATOR.
</p>
</dd>
<dt>apropos-desr string-designator &amp;optional set-designator =&gt; &lt;no values&gt;</dt><dd>

<p>
Like APROPOS, but finds objects from the domain of desire.
</p>
</dd>
<dt>apropos-desr-list string-designator &amp;optional set-designator =&gt; desirables</dt><dd>

<p>
Like APROPOS-LIST, but finds objects from the domain of desire.
</p>
</dd>
<dt>list-modules =&gt; &lt;no values&gt;</dt><dd>

<p>
List all known modules, with some additional information.
</p>
</dd>
<dt>module-hidden-p module-designator &amp;optional (locality (gate <code>*self*</code>)) =&gt; boolean</dt><dd>

<p>
See whether whether module designated by MODULE-DESIGNATOR is unavailable to anonymous remote clients.
</p>
</dd>
<dt>module-present-p module-designator &amp;optional (locality (gate <code>*self*</code>)) check-when-present-p (check-when-missing-p t) =&gt; boolean</dt><dd>

<p>
Determine whether module designated by MODULE-DESIGNATOR is present in LOCALITY, which defaults
to the local gate locality.
</p>
</dd>
<dt>local-summary &amp;optional (stream <code>*standard-output*</code>) =&gt; &lt;no values&gt;</dt><dd>

<p>
Print a summary about modules within the local gate to STREAM.
</p>
</dd>
<dt>module-best-remote module-designator &amp;key (if-does-not-exist :error) =&gt; remote</dt><dd>

<p>
Produce the remote, if any, which will be chosen to satisfy desires for module
designated by MODULE-DESIGNATOR.
</p>
</dd>
<dt>module-best-distributor module-designator &amp;key (if-does-not-exist :error) =&gt; remote</dt><dd>

<p>
Produce the distributor, if any, whose remote will be chosen to satisfy desires
for module designated by MODULE-DESIGNATOR.
</p>
</dd>
<dt>module-fetch-url module &amp;key allow-self =&gt; string</dt><dd>

<p>
Return the URL which is to be used while fetching MODULE, that is the location of MODULE in the preferred remote.
When ALLOW-SELF is specified, and non-NIL, remotes within <code>*SELF*</code> are not discarded from consideration.
</p>
</dd>
<dt>touch-module module =&gt; boolean, string</dt><dd>

<p>
Try 'access' MODULE via its preferred remote and return whether the attempt was successful as the primary value,
and the output of the toucher executable as the secondary value.
</p>
</dd>
<dt>system-loadable-p system-designator &amp;optional (locality (gate <code>*self*</code>)) =&gt; generalised-boolean</dt><dd>

<p>
Determine whether system designated by SYSTEM-DESIGNATOR is loadable in LOCALITY, which defaults
to the local gate locality.
</p></dd>
</dl>


</div>

</div>

<div id="outline-container-7_3" class="outline-3">
<h3 id="sec-7_3"><span class="section-number-3">7.3</span> Making wishes </h3>
<div class="outline-text-3" id="text-7_3">


<dl>
<dt>desire module-name-or-names =&gt; boolean</dt><dd>

<p>
Make modules with MODULE-NAME-OR-NAMES locally available.
</p>
</dd>
<dt>add-module url &amp;key module-name systemlessp (system-type desr:*default-system-type*) obtain =&gt; module</dt><dd>

<p>
Define a new module, with download location specified by URL, and the module's name
either deduced from the URL, or provided via MODULE-NAME.
</p>
<p>
When OBTAIN is non-NIL, the module is fetched after its definition is internalised.
</p>
</dd>
<dt>update module-designator &amp;optional (locality (gate <b>self</b>)) =&gt; &lt;no values&gt;</dt><dd>

<p>
Update a module specified by MODULE-DESIGNATOR, possibly specifying the target LOCALITY.
</p>
</dd>
<dt>make-module-unpublished module-designator &amp;optional (locality (gate <code>*self*</code>))</dt><dd>

<p>
Stop advertising MODULE in DEFINITIONS, without completely hiding it.
If it is hidden, unhide it.
</p>
</dd>
<dt>hide-module module-designator &amp;optional (locality (gate <code>*self*</code>))</dt><dd>

<p>
Stop advertising MODULE in DEFINITIONS, as well as make it inaccessible
to general public through LOCALITY.
</p>
</dd>
<dt><code>*fetch-errors-serious*</code> =&gt; boolean</dt><dd>

<p>
Whether to raise an error when external executables fail to fetch modules during DESIRE or UPDATE.
Defaults to NIL.
</p>
</dd>
<dt><code>*follow-upstream*</code> =&gt; boolean</dt><dd>

<p>
Whether tracking upstream should update HEAD.
Defaults to T.
</p>
</dd>
<dt><code>*dirty-repository-behaviour*</code> =&gt; keyword</dt><dd>

<p>
Whenever a dirty repository comes up in a situation which requires
a clean one to proceed, do accordingly to the value of this variable:
</p><ul>
<li>
:RESET  -  reset the dirty repository, losing unsaved changes,
</li>
<li>
:STASH  -  reset the dirty repository, stashing unsaved changes,
</li>
<li>
:ERROR  -  raise an error.
</li>
</ul>
</dd>
</dl>

<p>Defaults to :RESET.
</p>

</div>

<div id="outline-container-7_3_1" class="outline-4">
<h4 id="sec-7_3_1"><span class="section-number-4">7.3.1</span> Reader macros for add-module </h4>
<div class="outline-text-4" id="text-7_3_1">


<p>
Following reader macro is enabled by install-add-module-reader:
</p>
<pre class="example">
#@"u://r.l"
#@("u://r.l" &amp;key name obtain)
</pre>


</div>
</div>

</div>

<div id="outline-container-7_4" class="outline-3">
<h3 id="sec-7_4"><span class="section-number-3">7.4</span> Less frequently used functions </h3>
<div class="outline-text-3" id="text-7_4">


<dl>
<dt>system-definition system repository-path &amp;key (if-does-not-exist :error) =&gt; pathname</dt><dd>

<p>
Return the pathname of the SYSTEM's definition.
</p>
</dd>
<dt>clear-definitions =&gt; &lt;no values&gt;</dt><dd>

<p>
Forget everything. A subsequent READ-DEFINITIONS will be instrumental to continue any productive use.
</p>
</dd>
<dt>remove-remote remote-designator &amp;key keep-modules =&gt; nil</dt><dd>

<p>
Forget everything associated with a remote specified by REMOTE-DESIGNATOR, optionally, when KEEP-MODULES
is non-NIL, keeping modules referred by it.
</p>
</dd>
<dt>remove-module module-designator &amp;key keep-localities =&gt; nil</dt><dd>

<p>
Forget everything associated with module specified by MODULE-DESIGNATOR, including
its systems and applications.
</p>
</dd>
<dt>remove-system system-designator =&gt; nil</dt><dd>

<p>
Forget everything associated with the system specified by SYSTEM-DESIGNATOR.
</p>
</dd>
<dt>save-definitions &amp;key seal =&gt; &lt;no values&gt;</dt><dd>

<p>
Write out the current idea about the desire's domain into DEFINITIONS,
optionally committing changes, when SEAL is non-NIL.
</p>
</dd>
<dt>read-definitions &amp;key (source <b>self</b>) (force-source (eq source <b>self</b>)) (metastore (meta-path)) =&gt; &lt;no values&gt;</dt><dd>

<p>
Append definitions currently available in METASTORE to the current idea about
desire's domain.
</p></dd>
</dl>


</div>
</div>

</div>

<div id="outline-container-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Shortcomings </h2>
<div class="outline-text-2" id="text-8">


<p>
Some known problems:
</p>
<ul>
<li>
SBCL-only
</li>
<li>
ASDF-only
</li>
<li>
Linux-only (might work on other unices)
</li>
<li>
has a non-trivial amount of CL library dependencies, half of them
not exactly being common
</li>
<li>
calls out to an obscene amount of external executables, thereby only
being able to guess about failure reasons
</li>
</ul>



<hr/>
















</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> Git-centric.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.2" href="#fnr.2">2</a></sup> Three of them: full information, incremental and an ASDF-INSTALL-like post-factum one.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.3" href="#fnr.3">3</a></sup> It's a heuristic, if you are curious, but it works pretty well.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.4" href="#fnr.4">4</a></sup> Intermittent availability only, as of now.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.5" href="#fnr.5">5</a></sup> This is tied to the concept of well known release locations and differs
from the set of modules converted and reexported in the wishmaster
process.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.6" href="#fnr.6">6</a></sup> Available through git://github.com/purcell/darcs-to-git.git/
</p>
<p class="footnote"><sup><a class="footnum" name="fn.7" href="#fnr.7">7</a></sup> Actually, sometimes a group of domain names, like in case of sourceforge.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.8" href="#fnr.8">8</a></sup> Currently supported release mechanisms are: git, darcs, cvs, svn and tarballs.
Additionally, this is extended by some transport variety, like, for example, rsync.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.9" href="#fnr.9">9</a></sup> The term is borrowed from the git terminology.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.10" href="#fnr.10">10</a></sup> As per MODULE-LOCALLY-PRESENT-P.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.11" href="#fnr.11">11</a></sup> In git this is accomplished by ensuring that the relevant repository lacks
a .git/git-daemon-export-ok file.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.12" href="#fnr.12">12</a></sup> Currently, the only backend system implemented is ASDF.
</p>
<p class="footnote"><sup><a class="footnum" name="fn.13" href="#fnr.13">13</a></sup> Recovering such hidden systems complicates construction of full dependency graph in case of ASDF.
</p>
</div>
</div>
<div id="postamble">
<p class="author"> Author: Samium Gromoff
</p>
<p class="date"> Date: 2011-01-27 15:07:31 MSK</p>
<p class="creator">HTML generated by org-mode 7.4 in emacs 23</p>
</div>
</div>
</body>
</html>
